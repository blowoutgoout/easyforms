_.each(["Model","Collection"],function(e){var t=Backbone[e],i=t.prototype.fetch;t.prototype.fetch=function(){return this.trigger("fetch",this),i.apply(this,arguments)}});var PubSub=_.extend({},Backbone.Events);Backbone.View.prototype.close=function(){this.remove(),this.unbind(),this.onClose&&this.onClose()},_.templateSettings={evaluate:/\{\{(.+?)\}\}/g,interpolate:/\{\{=(.+?)\}\}/g,escape:/\{\{-(.+?)\}\}/g};var App=App||{};App.Data={variables:options.variables,actions:[{name:"toShow",label:options.i18n.show,fields:[{label:"",name:"target",fieldType:"select",options:[{label:options.i18n.field,name:"field",fields:[{label:"",name:"targetField",fieldType:"select",options:options.fields}]},{label:options.i18n.element,name:"element",fields:[{label:"",name:"targetElement",fieldType:"text"}]}]}]},{name:"toHide",label:options.i18n.hide,fields:[{label:"",name:"target",fieldType:"select",options:[{label:options.i18n.field,name:"field",fields:[{label:"",name:"targetField",fieldType:"select",options:options.fields}]},{label:options.i18n.element,name:"element",fields:[{label:"",name:"targetElement",fieldType:"text"}]}]}]},{name:"toEnable",label:options.i18n.enable,fields:[{label:"",name:"target",fieldType:"select",options:[{label:options.i18n.field,name:"field",fields:[{label:"",name:"targetField",fieldType:"select",options:options.fields}]},{label:options.i18n.element,name:"element",fields:[{label:"",name:"targetElement",fieldType:"text"}]}]}]},{name:"toDisable",label:options.i18n.disable,fields:[{label:"",name:"target",fieldType:"select",options:[{label:options.i18n.field,name:"field",fields:[{label:"",name:"targetField",fieldType:"select",options:options.fields}]},{label:options.i18n.element,name:"element",fields:[{label:"",name:"targetElement",fieldType:"text"}]}]}]},{label:options.i18n.copy,name:"copy",fields:[{label:options.i18n.from,name:"original",fieldType:"select",options:[{label:options.i18n.field,name:"field",fields:[{label:"",name:"originalField",fieldType:"select",options:options.fields}]},{label:options.i18n.element,name:"element",fields:[{label:"",name:"originalElement",fieldType:"text"}]}]},{label:options.i18n.to,name:"target",fieldType:"select",options:[{label:options.i18n.field,name:"field",fields:[{label:"",name:"targetField",fieldType:"select",options:options.fields}]},{label:options.i18n.element,name:"element",fields:[{label:"",name:"targetElement",fieldType:"text"}]}]}]},{label:options.i18n.math,name:"performArithmeticOperations",fields:[{label:options.i18n.perform,name:"operator",fieldType:"select",options:[{label:options.i18n.addition,name:"+"},{label:options.i18n.subtraction,name:"-"},{label:options.i18n.multiplication,name:"*"},{label:options.i18n.division,name:"/"},{label:options.i18n.remainder,name:"%"}]},{label:options.i18n.of,name:"operands",fieldType:"select_multiple",options:options.fields},{label:options.i18n.andSetResultTo,name:"target",fieldType:"select",options:[{label:options.i18n.field,name:"field",fields:[{label:"",name:"targetField",fieldType:"select",options:options.fields}]},{label:options.i18n.element,name:"element",fields:[{label:"",name:"targetElement",fieldType:"text"}]}]}]},{name:"formatNumber",label:options.i18n.formatNumber,fields:[{label:options.i18n.of,name:"target",fieldType:"select",options:[{label:options.i18n.field,name:"field",fields:[{label:"",name:"targetField",fieldType:"select",options:options.fields}]},{label:options.i18n.element,name:"element",fields:[{label:"",name:"targetElement",fieldType:"text"}]}]},{label:"As",name:"format",fieldType:"text"}]},{name:"skip",label:options.i18n.skip,fields:[{name:"step",label:options.i18n.toStep,fieldType:"select",options:options.steps}]}],variable_type_operators:{text:textOperators,tel:textOperators,color:colorOperators,url:textOperators,password:textOperators,number:numberOperators,range:numberOperators,date:dateOperators,"datetime-local":dateOperators,time:dateOperators,month:dateOperators,week:dateOperators,email:emailOperators,textarea:textOperators,select:selectOperators,checkbox:checkboxOperators,radio:radioOperators,hidden:hiddenOperators,file:fileOperators,button:buttonOperators,form:formOperators}},App.ActionsView=Backbone.View.extend({template:_.template($("#actions-template").html()),events:{"click button#add-rule":function(e){e.preventDefault(),this.collection.add({form_id:options.formID,status:1,opposite:1})}},render:function(){return this.el.innerHTML=this.template(),this}}),App.RulesView=Backbone.View.extend({className:"rule-builder",subViews:{},template:_.template($("#rules-template").html()),events:{"update-sort":"updateSort"},initialize:function(){this.listenTo(this.collection,"add",this.onAdd),this.listenTo(this.collection,"destroy",this.onDestroy),PubSub.on("rule:duplicated",this.onDuplicate,this),$(this.el).sortable({placeholder:"ui-sortable-placeholder",stop:function(e,t){t.item.trigger("drop",t.item.index())}})},updateSort:function(e,t,i){this.collection.remove(t),this.collection.each(function(e,t){var n=t;t>=i&&(n+=1),e.set("ordinal",n)}),t.set("ordinal",i),this.collection.add(t,{at:i});var n=this.collection.pluck("id"),o={form_id:options.formID,ids:n};$.ajax({data:o,type:"POST",url:options.positionEndPoint}).done(function(){$.notify({icon:"glyphicon glyphicon-ok",message:options.i18n.orderUpdated},{type:"success",placement:{from:"bottom",align:"center"},delay:1e3,template:'<div data-notify="container" class="col-xs-9 col-sm-3 alert alert-{0}" role="alert"><button type="button" aria-hidden="true" class="close" data-notify="dismiss">Ã—</button><span data-notify="icon"></span> <span data-notify="title">{1}</span> <span data-notify="message">{2}</span><div class="progress" data-notify="progressbar"><div class="progress-bar progress-bar-{0}" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;"></div></div><a href="{3}" target="{4}" data-notify="url"></a></div>'})}),this.render(),$(this.el).sortable("refresh")},onAdd:function(e){this.addSubview(e)},onDuplicate:function(e){this.collection.add(e.toJSON())},onDestroy:function(e){this.subViews[e.cid].close()},addSubview:function(e){this.subViews[e.cid]=new App.RuleView({model:e}),this.$el.append(this.subViews[e.cid].render().el)},closeSubviews:function(){_.invoke(this.subViews,"close")},onClose:function(){this.closeSubviews(),this.undelegateEvents(),this.$el.removeData().unbind(),this.remove(),Backbone.View.prototype.remove.call(this)},render:function(){return this.closeSubviews(),this.el.innerHTML=this.template(),this.collection.each(this.addSubview.bind(this)),this}}),App.RuleView=Backbone.View.extend({template:_.template($("#rule-template").html()),tagName:"div",className:"rules-group-container",events:{"click form .btn":"changeModel","remove .remove":"changeModel","change :input":"changeModel","click .save-rule":"saveModel","click .duplicate-rule":"duplicateModel","click .delete-rule":"deleteModel",drop:"drop"},initialize:function(){this.listenTo(this.model,"change",this.onChange)},drop:function(e,t){this.$el.trigger("update-sort",[this.model,t])},onChange:function(){this.render()},changeModel:function(e){e.preventDefault(),this.$(".label-warning").show()},saveModel:function(e){e.preventDefault();var t=this.$("#"+this.model.cid+"conditions"),i=this.$("#"+this.model.cid+"actions"),n=this.$("#"+this.model.cid+"status").is(":checked")?1:0,o=this.$("#"+this.model.cid+"opposite").is(":checked")?1:0;this.model.set({conditions:JSON.stringify(t.conditionsBuilder("data")),actions:JSON.stringify(i.actionsBuilder("data")),status:n,opposite:o}),this.model.save()},duplicateModel:function(e){e.preventDefault();var t=this.model.clone();t.unset("id"),PubSub.trigger("rule:duplicated",t)},deleteModel:function(e){return e.preventDefault(),this.model.isNew()?this.model.destroy():confirm(options.i18n.areYouSureDeleteItem)&&this.model.destroy(),!1},onClose:function(){this.undelegateEvents(),this.$el.removeData().unbind(),this.remove(),Backbone.View.prototype.remove.call(this)},displayRuleBuilder:function(){var e=this.$("#"+this.model.cid+"conditions"),t=this.$("#"+this.model.cid+"actions");this.model.has("conditions")&&_.isString(this.model.get("conditions"))?e.conditionsBuilder($.extend({},App.Data,{data:JSON.parse(this.model.get("conditions"))})):e.conditionsBuilder(App.Data),this.model.has("actions")&&_.isString(this.model.get("actions"))?t.actionsBuilder($.extend({},App.Data,{data:JSON.parse(this.model.get("actions"))})):t.actionsBuilder(App.Data)},render:function(){return this.el.innerHTML=this.template({cid:this.model.cid,rule:this.model.toJSON()}),this.model.isNew()&&this.$(".label-warning").show(),this.displayRuleBuilder(),this}});var Router=Backbone.Router.extend({views:{},initialize:function(e){this.main=e.main,this.rules=e.rules},routes:{"":"index"},closeViews:function(){_.invoke(this.views,"close")},index:function(){this.closeViews(),this.views.rulesView=new App.RulesView({collection:this.rules}),this.main.append(this.views.rulesView.render().el),this.views.actionsView=new App.ActionsView({collection:this.rules}),this.main.append(this.views.actionsView.render().el)}}),Rule=Backbone.Model.extend({url:function(){var e=_.result(this,"urlRoot")||_.result(this.collection,"url")||urlError();return this.isNew()?e:e+("/"===e.charAt(e.length-1)?"":"&id=")+encodeURIComponent(this.id)},methodUrl:function(e){return"delete"==e?options.deleteEndPoint+"&id="+this.attributes.id:"update"==e?options.updateEndPoint+"&id="+this.attributes.id:"create"==e&&options.createEndPoint+"&id="+this.attributes.id},sync:function(e,t,i){t.methodUrl&&t.methodUrl(e.toLowerCase())&&((i=i||{}).url=t.methodUrl(e.toLowerCase())),Backbone.sync(e,t,i)},initialize:function(){}}),Rules=Backbone.Collection.extend({url:options.endPoint,model:Rule,initialize:function(){options.hasPrettyUrls&&(this.model=Backbone.Model)},comparator:function(e){return e.get("ordinal")},parse:function(e){return this.pager=e._meta,e.items},fetchPage:function(){var e=this;return this.fetch({data:$.param({id:options.formID}),reset:!0,success:function(){e.trigger("sync:page")}})}});App.init=function(){return App.Rules=new Rules,App.Rules.fetchPage().then(function(){App.Router=new Router({main:$("#main"),rules:App.Rules}),Backbone.history.start()})},$(function(){App.init()});
(function(f){f.fn.conditionsBuilder=function(j){if(j=="data"){var i=f(this).eq(0).data("conditionsBuilder");return i.collectData()}else{return f(this).each(function(){var k=new a(this,j);f(this).data("conditionsBuilder",k)})}};function a(j,i){this.element=f(j);this.options=i||{};this.init()}a.prototype={init:function(){this.fields=this.denormalizeOperators(this.options.variables,this.options.variable_type_operators);this.data=this.options.data||{all:[]};var i=this.buildRules(this.data);this.element.html(i)},denormalizeOperators:function(j,i){return f.map(j,function(k){k.operators=i[k.fieldType];return k})},collectData:function(){return this.collectDataFromNode(this.element.find("> .conditional"))},collectDataFromNode:function(k){var i=null;var l=this;if(k.is(".conditional")){i=k.find("> .all-any-none-wrapper > .all-any-none").val()}if(i){var j={};j[i]=[];k.find("> .conditional, > .rule").each(function(){j[i].push(l.collectDataFromNode(f(this)))});return j}else{return{name:k.find(".field").val(),operator:k.find(".operator").val(),value:k.find(".value").val()}}},buildRules:function(i){return this.buildConditional(i)||this.buildRule(i)},buildConditional:function(m){var n;if(m.all){n="all"}else{if(m.any){n="any"}else{if(m.none){n="none"}}}if(!n){return}var l=f("<div>",{"class":"conditional "+n});var p=f("<div>",{"class":"all-any-none-wrapper"});var v=f("<select>",{"class":"all-any-none form-control"});v.append(f("<option>",{value:"all",text:options.i18n.all,selected:n=="all"}));v.append(f("<option>",{value:"any",text:options.i18n.any,selected:n=="any"}));v.append(f("<option>",{value:"none",text:options.i18n.none,selected:n=="none"}));p.append(v);p.append(f("<span>",{text:options.i18n.followingConditions}));l.append(p);var k=f("<span>",{"class":"glyphicon glyphicon-plus",text:" "});var j=f("<a>",{href:"#","class":"add-rule btn btn-warning btn-xs",text:options.i18n.addCondition});j.prepend(k);j.prepend(k);var q=this;j.click(function(x){x.preventDefault();var i=q.fields[0];var y={name:i.value,operator:i.operators[0],value:null};l.append(q.buildRule(y))});l.append(j);var u=f("<span>",{"class":"glyphicon glyphicon-plus",text:" "});var t=f("<a>",{href:"#","class":"add-condition btn btn-warning btn-xs",text:options.i18n.addGroup});t.prepend(u);t.click(function(x){x.preventDefault();var i=q.fields[0];var y={all:[{name:i.value,operator:i.operators[0],value:null}]};l.append(q.buildConditional(y))});l.append(t);var s=f("<span>",{"class":"glyphicon glyphicon-remove",text:" "});var r=f("<a>",{"class":"remove btn btn-danger btn-xs",href:"#",text:options.i18n.deleteText});r.prepend(s);r.click(function(i){i.preventDefault();f(this).trigger("remove");l.remove()});l.append(r);var w=m[n];for(var o=0;o<w.length;o++){l.append(this.buildRules(w[o]))}return l},buildRule:function(i){var l=f("<div>",{"class":"rule"});var j=d(this.fields,i);var k=h();j.change(b.call(this,k,i));l.append(j);l.append(k);l.append(g());j.change();l.find("> .value").val(i.value);return l},operatorsFor:function(l){for(var j=0;j<this.fields.length;j++){var k=this.fields[j];if(k.name==l){return k.operators}}}};function d(l,k){var j=f("<select>",{"class":"field form-control"});for(var m=0;m<l.length;m++){var o=l[m];var n=f("<option>",{text:o.label,value:o.name,selected:k.name==o.name});n.data("options",o.options);j.append(n)}return j}function h(){var i=f("<select>",{"class":"operator form-control"});i.change(c);return i}function g(){var i=f("<span>",{"class":"glyphicon glyphicon-remove",text:" "});var j=f("<a>",{"class":"remove btn btn-danger btn-xs",href:"#",text:options.i18n.deleteText});j.prepend(i);j.click(e);return j}function e(i){i.preventDefault();f(i.currentTarget).trigger("remove").parents(".rule").remove()}function b(k,i){var j=this;return function(p){var l=j.operatorsFor(f(p.target).val());k.empty();for(var n=0;n<l.length;n++){var m=l[n];var o=f("<option>",{text:m.label||m.name,value:m.name,selected:i.operator==m.name});o.data("fieldType",m.fieldType);k.append(o)}k.change()}}function c(p){var q=f(this);var o=q.find("> :selected");var k=q.parents(".rule");var j=k.find(".field");var t=k.find(".value");var m=t.val();switch(o.data("fieldType")){case"none":q.after(f("<input>",{type:"hidden","class":"value form-control"}));break;case"text":q.after(f("<input>",{type:"text","class":"value form-control"}));break;case"email":q.after(f("<input>",{type:"email","class":"value form-control"}));break;case"number":q.after(f("<input>",{type:"number","class":"value form-control"}));break;case"color":q.after(f("<input>",{type:"color","class":"value form-control"}));break;case"range":q.after(f("<input>",{type:"range","class":"value form-control"}));break;case"textarea":q.after(f("<textarea>",{"class":"value form-control"}));break;case"select":var r=f("<select>",{"class":"value form-control"});var u=j.find("> :selected").data("options");for(var n=0;n<u.length;n++){var l=u[n];r.append(f("<option>",{text:l.label||l.value,value:l.value}))}q.after(r);break;case"select_multiple":var u=j.find("> :selected").data("options");var s=u.length>10?10:u.length;var r=f("<select class='value form-control' multiple size='"+s+"''></select>");for(var n=0;n<u.length;n++){var l=u[n];r.append(f("<option>",{text:l.label||l.value,value:l.value}))}q.after(r);break}t.remove()}})(jQuery);
_.templateSettings={evaluate:/\{\{(.+?)\}\}/g,interpolate:/\{\{=(.+?)\}\}/g,escape:/\{\{-(.+?)\}\}/g};var gridEl,gridStack,charts;$(document).ready(function(){d3.json(options.endPoint,function(c){gridEl=$(".grid-stack");gridEl.gridstack({cell_height:90,vertical_margin:10});gridStack=gridEl.data("gridstack");charts=[];var p="#475e98";var o="#9B59B6";var m="#F8B700";var k="#78CC00";var h="#7B71C5";var g="#56B2EA";var e="#E064CD";var b=[p,o,m,k,h,g,e,p,o,m,k,h,g,e];var j=false;var q=crossfilter(c);var l=q.groupAll();var i=dc.dataCount(".data-count").dimension(q).group(l);i.render();var a=function(A,v,r,B,C,z,D,u){var t=$("#widget").html();var s=_.template(t)({title:A,type:v,name:r,label:B});gridStack.add_widget($(s),C,z,D,u)};var d=function(t,v){var x=q.dimension(function(y){return y[t]});var s=x.group();var w=$("div").find("[data-name='"+t+"']");var u=w.width();var r=w.height();if(v==="pie"){charts[t]=dc.pieChart("#"+t);charts[t].width(u-80).height(r-80).ordinalColors(b).slicesCap(4).renderTitle(true).legend(dc.legend()).renderLabel(false).dimension(x).group(s)}else{if(v==="donut"){charts[t]=dc.pieChart("#"+t);charts[t].width(u-80).height(r-80).ordinalColors(b).dimension(x).group(s).innerRadius(Math.round((r-80)*20/100)).renderLabel(true).renderTitle(true)}else{if(v==="row"){charts[t]=dc.rowChart("#"+t);charts[t].width(u-40).height(r-80).ordinalColors(b).dimension(x).group(s).elasticX(true)}else{if(v==="bar"){charts[t]=dc.barChart("#"+t);charts[t].width(u-10).height(r-80).ordinalColors(b).x(d3.scale.ordinal()).xUnits(dc.units.ordinal).brushOn(false).dimension(x).barPadding(0.1).outerPadding(0.05).on("renderlet",function(y){y.selectAll("rect").attr("fill",function(A,z){return b[z]})}).group(s)}}}}charts[t].render()};var n=function(s,r,t){var u='<div class="alert alert-'+t+'" role="alert">';u+='<button type="button" class="close" data-dismiss="alert" aria-label="Close">';u+='<span aria-hidden="true">&times;</span>';u+="</button>";u+='<p><span class="glyphicon glyphicon-ok-sign"></span> '+r+"</p>";u+="</div>";$(s).append(u)};var f=function(r){$(r).empty()};_.each(options.charts,function(r){a(r.title,r.type,r.name,r.label,r.gsX,r.gsY,r.gsW,r.gsH);d(r.name,r.type)});gridStack.disable();gridEl.on("resizestop",function(){j=true});gridEl.on("change",function(x,s){if(j){var w=_.first(s).el;var t=w.data("name");var v=w.data("type");var u=w.width();var r=w.height();if(v==="bar"){charts[t].width(u-10).height(r-80).rescale().redraw()}else{if(v==="row"){charts[t].width(u-40).height(r-80).redraw()}else{if(v==="donut"){charts[t].width(u-80).height(r-80).innerRadius(Math.round((r-80)*20/100)).redraw()}else{charts[t].width(u-80).height(r-80).redraw()}}}}j=false});window.deleteChart=function(s){var r=$(s).data("name");var t=$("div").find("[data-name='"+r+"']");gridStack.remove_widget(t)};$("#enable").click(function(r){r.preventDefault();gridStack.enable();gridEl.addClass("grid-editable");$(".btn-for-toggle").toggle()});$("#disable").click(function(r){r.preventDefault();gridStack.disable();gridEl.removeClass("grid-editable");$(".btn-for-toggle").toggle()});$("#reset").click(function(r){r.preventDefault();gridStack.remove_all()});$("#formModal").on("show.bs.modal",function(v){var w=$(v.relatedTarget);var x=w.data("title");var u=$(this);if(typeof x==="undefined"){u.find("#chartTitle").val("");u.find("#chartType option:eq(0)").prop("selected",true);u.find("#field option:eq(0)").prop("selected",true);u.find("#field").prop("disabled",false)}else{var s=w.data("name");var r=w.data("label");var t=w.data("type");u.find("#chartTitle").val(x);u.find('#chartType option[value="'+t+'"]').prop("selected",true);u.find('#field option[value="'+s+'"]').prop("selected",true);u.find("#field").prop("disabled",true)}});$("#saveChart").on("click",function(z){z.preventDefault();var s=$("#chartTitle").val();var B=$("#chartType").val();var A=$("#field");var r=A.val();var t=A.children(":selected").text();if($("#"+r).length){var v=$("div").find("[data-name='"+r+"']");var D=v.data("gs-x");var C=v.data("gs-y");var E=v.data("gs-width");var u=v.data("gs-height");gridStack.remove_widget(v);a(s,B,r,t,D,C,E,u);d(r,B)}else{if(s.length===0){f("#modal-messages");n("#modal-messages","<strong>"+options.i18n.error+"</strong> "+options.i18n.errorMessage,"danger");return false}a(s,B,r,t,0,0,3,3);d(r,B)}});$("#saveReport").click(function(t){t.preventDefault();var r=_.map($(".grid-stack .grid-stack-item:visible"),function(v){v=$(v);var w=v.data("_gridstack_node");return{name:v.attr("data-name"),label:v.attr("data-label"),title:v.attr("data-title"),type:v.attr("data-type"),width:120,height:120,gsX:w.x,gsY:w.y,gsW:w.width,gsH:w.height}});var s={report:JSON.stringify(r),_csrf:options._csrf};var u=$.ajax({method:"POST",url:options.endPoint,dataType:"json",data:s}).done(function(v){if(v.success&&v.id>0){console.log(options);f("#messages");n("#messages","<strong>"+options.i18n.success+"</strong> "+options.i18n.updatedMessage,"success")}else{f("#messages");n("#messages","<strong>"+options.i18n.error+"</strong> "+options.i18n.errorOnUpdate,"danger")}}).fail(function(v){f("#messages");n("#messages","<strong>"+options.i18n.success+"</strong>"+options.i18n.errorOnUpdate,"danger");console.error(v)})})})});